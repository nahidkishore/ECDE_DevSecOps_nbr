# NamespaceLifecycle


# **Hands-On Lab: NamespaceLifecycle Admission Controller**  
*(Preventing Critical Namespace Deletion in Kubernetes)*  

---

## **üîç What is `NamespaceLifecycle`?**  
- A **built-in validating admission controller**  
- **Protects system namespaces** (`kube-system`, `kube-public`, etc.) from deletion  
- Prevents resource creation in **terminating namespaces**  
- **Enabled by default** in all Kubernetes clusters  

---

## **üõ†Ô∏è Lab 1: Test Namespace Protection**  

### **Step 1: Verify Controller is Enabled**  
```bash
kubectl get pods -n kube-system -l component=kube-apiserver -o yaml | grep enable-admission-plugins
```
*Expected Output:*  
```yaml
- --enable-admission-plugins=...,NamespaceLifecycle,...
```

### **Step 2: Attempt to Delete `kube-system`**  
```bash
kubectl delete namespace kube-system
```
*Expected Error:*  
```
Error from server (Forbidden): admission webhook "namespace-lifecycle" denied the request: deletion of namespace kube-system is forbidden
```

### **Step 3: Create a Custom Namespace**  
```bash
kubectl create namespace test-ns
kubectl delete namespace test-ns  # ‚úÖ Allowed (non-system namespace)
```

---

<img width="560" height="293" alt="Image" src="https://github.com/user-attachments/assets/d3fc6ef2-a290-42b7-a9ef-49ede213fab0" />

<img width="720" height="426" alt="Image" src="https://github.com/user-attachments/assets/cf8fa11c-aaca-4bcc-83ee-7b09bdacb18f" />

<img width="719" height="322" alt="Image" src="https://github.com/user-attachments/assets/ce343ed1-6661-4939-ab83-cf47cd0c0d4d" />

<img width="717" height="168" alt="Image" src="https://github.com/user-attachments/assets/5811c132-edbf-4065-b1b4-fee6ac8224dd" />

<img width="491" height="232" alt="Image" src="https://github.com/user-attachments/assets/ba979f79-3064-4cb9-93e5-b3c435f00476" />


## **üî¨ Lab 2: Observe Terminating State Behavior**  

### **Step 1: Start Namespace Deletion**  
```bash
kubectl create namespace demo-ns
kubectl delete namespace demo-ns --wait=false
```

# Method
# Terminal 1 - Create and delete in background
```bash
kubectl create ns demo-ns
(kubectl delete ns demo-ns --wait=false &)

# Terminal 2 - Immediately try to create pod
# kubectl run test-pod --image=nginx -n demo-ns
kubectl apply -f demo-pod-ns.yml

```


### **Step 2: Try Creating Resources**  

file name: 
```bash
kubectl apply -f demo-pod-ns.yml
```

```bash
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
  namespace: demo-ns
spec:
  containers:
  - name: nginx
    image: nginx
```

*Expected Error:*  
```
Error from server (Forbidden): admission webhook "namespace-lifecycle" denied the request: namespace demo-ns is terminating
```

<img width="598" height="450" alt="Image" src="https://github.com/user-attachments/assets/efd9a69d-edbf-4e4d-a5e2-c4bb533a789e" />

<img width="720" height="125" alt="Image" src="https://github.com/user-attachments/assets/bd71bb9a-bab5-4d4e-9948-e1a583e7c242" />



### **Check Namespace Status**  
```bash
kubectl get namespace demo-ns -w
```
*Observe:*  
1. `STATUS: Terminating`  
2. Finalizers block immediate deletion  

---

## **‚öôÔ∏è How It Works Internally**  
1. **API Request Flow**:  
   - User sends `delete namespace` request  
   - `NamespaceLifecycle` checks if namespace is protected  
   - Blocks request if namespace is `kube-system` or similar  

2. **Terminating State Logic**:  
   ```go
   if namespace.Status.Phase == "Terminating" {
       reject("Cannot create resources in terminating namespace")
   }
   ```

---

## **üíº Production Use Cases**  
1. **Protecting Critical Namespaces**:  
   - Prevents accidental deletion of `kube-system` (would crash cluster)  
2. **CI/CD Safety**:  
   - Blocks deployments during namespace cleanup  
3. **Multi-tenant Security**:  
   - Stops users from deleting shared system namespaces  

**Bangladesh Industry Example**:  
- **bKash** uses this to protect their `payment-system` namespace  

---

## **üö® Important Notes**  
1. **Cannot be disabled** without breaking cluster functionality  
2. **Custom Protection**: For non-system namespaces, use:  
   - Kyverno policies  
   - RBAC restrictions  

---

## **üéì Key Takeaways**  
1. `NamespaceLifecycle` is **Kubernetes' safety net** for namespaces  
2. Understand two key protections:  
   - **System namespace deletion prevention**  
   - **Blocking resource creation in terminating namespaces**  
3. Combine with **RBAC** for full namespace security  


