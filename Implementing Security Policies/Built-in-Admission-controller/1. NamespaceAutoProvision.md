# NamespaceAutoProvision


# **Hands-On Lab: NamespaceAutoProvision Admission Controller**  
*(Automatically Create Missing Namespaces on Resource Deployment)*  

---

## **üîç What is `NamespaceAutoProvision`?**  
- A **built-in mutating admission controller** in Kubernetes  
- **Automatically creates namespaces** when a resource references a non-existent namespace  
- Disabled by default in most distributions (need to explicitly enable)  

---

## **üõ†Ô∏è Lab Setup**  
### **Step 1: Verify if Controller is Enabled**  
```bash
kubectl get pods -n kube-system -l component=kube-apiserver -o yaml | grep enable-admission-plugins
```
*Typical Output (Without NamespaceAutoProvision):*  
```yaml
- --enable-admission-plugins=NodeRestriction,PodSecurity
```

### **Step 2: Enable `NamespaceAutoProvision`**  
Edit the API server manifest:  
```bash
sudo vi /etc/kubernetes/manifests/kube-apiserver.yaml
```
Add to arguments:  
```yaml
- --enable-admission-plugins=...,NamespaceAutoProvision
```
Save and wait for API server to restart (~1-2 mins).

---

## **üî¨ Lab Exercise: Auto-Create Namespaces**  
### **Scenario:**  
Deploy an `nginx` pod to a **non-existent namespace** and observe auto-creation.

### **Step 1: Deploy to Non-Existent Namespace**  
```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: nginx-demo
  namespace: auto-created-ns  # üéØ Doesn't exist yet!
spec:
  containers:
  - name: nginx
    image: nginx
EOF
```

### **Step 2: Verify Namespace Creation**  
```bash
kubectl get namespace auto-created-ns
```
*Expected Output:*  
```
NAME               STATUS   AGE
auto-created-ns    Active   15s
```

### **Step 3: Check Pod Status**  
```bash
kubectl get pods -n auto-created-ns
```
*Expected Output:*  
```
NAME         READY   STATUS    RESTARTS   AGE
nginx-demo   1/1     Running   0          30s
```

---

## **‚öôÔ∏è How It Works Internally**  
1. User submits request for resource in non-existent namespace  
2. API server checks `NamespaceAutoProvision` admission controller  
3. Controller:  
   - **Creates the namespace** (with default labels/annotations)  
   - **Allows the resource creation** in the new namespace  

---

## **üö® Important Notes**  
1. **Security Implications**:  
   - Not recommended for production (can lead to uncontrolled namespace sprawl)  
   - Better alternative: Use CI/CD to enforce namespace creation  

2. **Real-World Use Case**:  
   - **Development environments** where rapid prototyping is needed  
   - **Legacy systems** migrating to Kubernetes  

3. **Disable After Lab**:  
   ```bash
   sudo vi /etc/kubernetes/manifests/kube-apiserver.yaml
   ```
   Remove `NamespaceAutoProvision` from enabled plugins.


## **üéì Key Takeaways**  
1. `NamespaceAutoProvision` is **convenient but risky** for production  
2. Always **audit enabled admission controllers**  
3. For production, use **policy engines (Kyverno/OPA)** instead  


# History commands 

```bash

    2  kubectl get pods -n kube-system
    3  kubectl get pods -n kube-system kube-apiserver-ip-172-31-46-109 -o yaml | grep admission
    4  kubectl get pods -n kube-system kube-apiserver-ip-172-31-46-109 -o yaml
    5  cd /etc/kubernetes/manifests/
    6  ls -lrt
    7  cat kube-apiserver.yaml
    8  sudo cat kube-apiserver.yaml
    9  ls -lrt
   10  sudo vim kube-apiserver.yaml
   11  cd
   12  kubectl get pods -n kube-system kube-apiserver-ip-172-31-46-109 -o yaml | grep admission
   13  kubectl get pods -n kube-system
   14  kubectl get pods -n kube-system kube-apiserver-ip-172-31-46-109 -o yaml | grep admission
   15  ls
   16  vim nsauto-pod.yml
   17  kubectl get ns
   18  ls
   19  kubectl apply -f nsauto-pod.yml
   20  kubectl get ns
   21  kubectl get pods -n auto-created-ns
   22  cat nsauto-pod.yml

```

---





<img width="569" height="289" alt="Image" src="https://github.com/user-attachments/assets/0fab4759-3328-4455-80d8-c867df670625" />

<img width="720" height="395" alt="Image" src="https://github.com/user-attachments/assets/68247c58-8ba0-4609-975b-f8ba101d5092" />

<img width="682" height="362" alt="Image" src="https://github.com/user-attachments/assets/fbdd10c9-3203-4880-ad70-a00c1da76049" />

<img width="720" height="149" alt="Image" src="https://github.com/user-attachments/assets/9e79e749-c681-4967-aacb-6eb5bbbb4f70" />

<img width="717" height="425" alt="Image" src="https://github.com/user-attachments/assets/a00b4f37-2ff6-4516-9c3d-fbf5a50b9ce0" />

<img width="650" height="33" alt="Image" src="https://github.com/user-attachments/assets/36caa74b-9ec7-4236-9103-ee5b689a46ec" />

<img width="718" height="313" alt="Image" src="https://github.com/user-attachments/assets/2435f68d-73ad-4ed7-aef7-da89419e9853" />

<img width="720" height="382" alt="Image" src="https://github.com/user-attachments/assets/62e02452-cafd-42c2-a1ae-373ef5fd41ea" />

<img width="400" height="163" alt="Image" src="https://github.com/user-attachments/assets/44f6613d-e836-4cbe-9a8a-d317145bce46" />

---

# Testing for remove NamespaceAutoProvision controller and test again and create pod.


```yml

apiVersion: v1
kind: Pod
metadata:
  name: nginx-demo
  namespace: test-auto-created-ns  # üéØ Doesn't exist yet!
spec:
  containers:
  - name: nginx
    image: nginx

```



<img width="720" height="324" alt="Image" src="https://github.com/user-attachments/assets/6abd4840-cdf9-4f45-acff-e810ea592a94" />

<img width="720" height="394" alt="Image" src="https://github.com/user-attachments/assets/b87f0af1-2218-48b9-97f8-f75ae5b35559" />


# History: 

```bash
   24  cd /etc/kubernetes/manifests/
   25  ls
   26  sudo vim kube-apiserver.yaml
   27  ls
   28  cd
   29  kubectl get pods -n kube-system kube-apiserver-ip-172-31-46-109 -o yaml | grep admission
   30  ls
   31  cp nsauto-pod.yml test-nsauto-pod.yml
   32  ls
   33  vim test-nsauto-pod.yml
   34  cat test-nsauto-pod.yml
   35  kubectl get ns
   36  kubectl apply -f test-nsauto-pod.yml

```