# **Hands-On Lab: PodSecurity Admission Controller (PSA)**  
*(Kubernetes Pod Security Enforcement Masterclass)*  

---

## **🔍 PodSecurity Admission (PSA) Ki?**  
Kubernetes er **built-in admission controller** je:  
✅ Pods er security context check kore  
✅ **3 modes** e kaj kore: **enforce**, **audit**, **warn**  
✅ PodSecurityPolicy (PSP) er replacement  

**Real-World Use Case:**  
- **bKash** uses PSA to block privileged containers in production  
- **Pathao** enforces `runAsNonRoot` across all namespaces  

---

## **🛠️ Lab 1: PSA Setup & Modes**  

### **Step 1: Check PSA Status**  
```bash
kubectl get pods -n kube-system -l component=kube-apiserver -o yaml | grep enable-admission-plugins
```
*Output:*  
```yaml
- --enable-admission-plugins=...,PodSecurity,...
```

### **Step 2: Configure Namespace Labels**  
```bash
# Create test namespace
kubectl create ns psa-test

# Apply PSA labels (enforce restricted policy)
kubectl label ns psa-test \
  pod-security.kubernetes.io/enforce=restricted \
  pod-security.kubernetes.io/enforce-version=v1.33 \
  pod-security.kubernetes.io/warn=restricted \
  pod-security.kubernetes.io/audit=restricted
```

---

## **🔬 Lab 2: Test Security Enforcement**  

### **Case 1: Privileged Pod (Blocked)**  
```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod
  namespace: psa-test
spec:
  containers:
  - name: nginx
    image: nginx
    securityContext:
      privileged: true  # ❌ Violation
EOF
```
*Expected Error:*  
```
Error from server (Forbidden): pods "privileged-pod" is forbidden: violates PodSecurity "restricted:v1.28": privileged (container "nginx" must not set securityContext.privileged=true)
```

### **Case 2: Non-Root Pod (Allowed)**  
```bash
apiVersion: v1
kind: Pod
metadata:
  name: safe-pod
  namespace: psa-test
spec:
  containers:
  - name: nginx
    image: nginx
    securityContext:
      runAsNonRoot: true  # ✅ Compliant
      allowPrivilegeEscalation: false
```
*Verify:*  
```bash
kubectl get pods -n psa-test
```

---

## **📊 PSA Levels Comparison**  
| **Level**       | **Requirements**                          | **Production Use**          |  
|-----------------|------------------------------------------|-----------------------------|  
| **Privileged**  | No restrictions                          | Never use                   |  
| **Baseline**    | Prevent known exploits                   | Dev/Staging                 |  
| **Restricted**  | Maximum security (PCI-DSS compliant)     | Production                  |  

**Example Policy Matrix:**  
```bash
kubectl label ns production \
  pod-security.kubernetes.io/enforce=restricted \
  pod-security.kubernetes.io/enforce-version=v1.33
```

---


---

## **💼 Production Deployment Strategy**  

### **Phase 1: Monitor (Warn Mode)**  
```bash
kubectl label ns staging \
  pod-security.kubernetes.io/warn=restricted
```

### **Phase 2: Enforce Gradually**  
```bash
kubectl label ns production \
  pod-security.kubernetes.io/enforce=restricted \
  pod-security.kubernetes.io/warn=restricted
```

### **Phase 3: Full Enforcement**  
```bash
kubectl label ns production \
  pod-security.kubernetes.io/enforce=restricted
```

---

## **🛡️ PSA vs PSP vs OPA/Gatekeeper**  
| **Feature**       | **PSA**         | **PSP**         | **OPA**         |  
|--------------------|----------------|----------------|----------------|  
| **Built-in**       | ✅ Yes          | ✅ Yes (Deprecated) | ❌ No           |  
| **Policy Language**| Declarative    | JSON           | Rego           |  
| **Flexibility**    | Medium         | Low            | High           |  
| **Performance**    | Fast           | Medium         | Slower         |  

**Bangladesh Industry Choice:**  
- **bKash**: PSA + Kyverno for custom rules  
- **GP**: Pure PSA for simplicity  

---

## **🎓 Key Takeaways**  
1. PSA is **Kubernetes-native** pod security  
2. **3 Modes**: enforce/audit/warn for gradual rollout  
3. Always **start with warn mode** in production  
4. Combine with **network policies** for defense-in-depth  

**Next Steps:**  
- [ ] Try violating other PSA rules (hostPID, hostNetwork)  
- [ ] Integrate with CI/CD pipeline (e.g., fail builds on warn)  

Need the **custom PSA exemption policies lab**? Let me know! 🔐


---

# **Analysis of Your PodSecurity Admission (PSA) Test Results**

```
Error from server (Forbidden): error when creating "psa-test-pod.yml": pods "privileged-pod" is forbidden: violates PodSecurity "restricted:v1.33":
1. privileged (container "nginx" must not set securityContext.privileged=true)
2. allowPrivilegeEscalation != false (container "nginx" must set securityContext.allowPrivilegeEscalation=false)
3. unrestricted capabilities (container "nginx" must set securityContext.capabilities.drop=["ALL"])
4. runAsNonRoot != true (pod or container "nginx" must set securityContext.runAsNonRoot=true)
5. seccompProfile (pod or container "nginx" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost")
```

## **How to Create a Compliant Pod**

Here's a **fixed version** of your pod that will work in the `restricted` namespace:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: safe-pod
  namespace: psa-test
spec:
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  containers:
  - name: nginx
    image: nginx
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
```

Apply it with:
```bash
kubectl apply -f safe-pod.yml
```
---

# Solution for error runAsNonRoot: true |`CreateContainerConfigError` 


# **Understanding the `CreateContainerConfigError`**

The error occurs because the **nginx image by default runs as root**, but your PodSecurity policy requires `runAsNonRoot: true`. This is a fundamental security conflict.

## **Root Cause Analysis**

1. **PodSecurity Policy Conflict**:
   - You set `runAsNonRoot: true` in the pod spec
   - The official nginx image is configured to run as root (UID 0)
   - Kubernetes can't start the container because it violates security policy

2. **Error Message Breakdown**:
   ```
   Warning Failed: container has runAsNonRoot and image will run as root
   ```

## **Solutions**

### **Option 1: Use a Non-Root nginx Image**
Modify your YAML to use an nginx variant that runs as non-root:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: safe-pod
  namespace: psa-test
spec:
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  containers:
  - name: nginx
    image: nginxinc/nginx-unprivileged  # Official non-root image
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
```

### **Option 2: Override the User in Container**
Force the container to run as non-root:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: safe-pod
  namespace: psa-test
spec:
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  containers:
  - name: nginx
    image: nginx
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      runAsUser: 1000  # Explicit non-root UID
      runAsGroup: 1000
```


## **Why This Matters in Production**
1. **Security Best Practice**: Running containers as non-root reduces attack surface
2. **Compliance Requirements**: Many security standards (PCI-DSS, NIST) require non-root execution
3. **Least Privilege Principle**: Containers should only have minimum required permissions

## **Verification**
After applying the fix:
```bash
kubectl get pods -n psa-test
kubectl logs safe-pod -n psa-test
```



# History commands:

```bash
  110 kubectl get pods -n kube-system kube-apiserver-ip-172-31-39-112 -o yaml | grep admission
kubectl create ns psa-test
  111  kubectl get ns
  112  kubectl label ns psa-test   pod-security.kubernetes.io/enforce=restricted   pod-security.kubernetes.io/enforce-version=v1.33   pod-security.kubernetes.io/warn=restricted   pod-security.kubernetes.io/audit=restricted
  113  kubectl get ns --show-labels
  158 vi psa-test-pod.yml
  159  cat psa-test-pod.yml
  160  kubectl get ns
  161  cat psa-test-pod.yml
  162  kubectl apply -f psa-test-pod.yml
  163  vi psa-test-pod.yml
  164  cat psa-test-pod.yml
  165  kubectl apply -f psa-test-pod.yml
  166  ls
  167  cat safe-psa-pod.yml
  168  vim safe-psa-pod.yml
  169  cat safe-psa-pod.yml
  170  kubectl apply -f safe-psa-pod.yml
  171  kubectl get pods -n psa-test
  172  kubect describe pods safe-pod -n psa-test
  173  kubectl describe pods safe-pod -n psa-test
  174  ls
  175  cat non-root-safe-psa-pod.yml
  176  kubect get pods -n psa-test
  177  kubectl get pods -n psa-test
  178  kubectl delete pods safe-pod -n psa-test
  179  kubectl get pods -n psa-test
  180  cat non-root-safe-psa-pod.yml
  181  kubectl apply -f non-root-safe-psa-pod.yml
  182  kubectl get pods -n psa-test
  183  kubectl describe pods safe-pod -n psa-test

```


<img width="720" height="189" alt="Image" src="https://github.com/user-attachments/assets/cd463a65-d15a-4c6e-ad8a-87e3879cb001" />

<img width="467" height="203" alt="Image" src="https://github.com/user-attachments/assets/e93a41f1-2136-40a3-ac12-db4b31104536" />

<img width="720" height="149" alt="Image" src="https://github.com/user-attachments/assets/0223d36f-0432-430b-851f-a30020d4cd51" />

<img width="720" height="370" alt="Image" src="https://github.com/user-attachments/assets/cd5eec04-99d2-4c64-900d-e82990c0051e" />

<img width="720" height="369" alt="Image" src="https://github.com/user-attachments/assets/20316c8c-e49e-4e40-a5a0-bdbafbcb04d1" />

<img width="575" height="435" alt="Image" src="https://github.com/user-attachments/assets/240a6d19-3ea8-47df-9e78-e9693c62c327" />

<img width="720" height="316" alt="Image" src="https://github.com/user-attachments/assets/5fdffdd3-3b10-4574-bfa2-3870c7b564b6" />

<img width="603" height="437" alt="Image" src="https://github.com/user-attachments/assets/aae5c31e-a213-4353-bbc6-75cbb384a4b9" />

<img width="720" height="289" alt="Image" src="https://github.com/user-attachments/assets/e14c8547-8655-4986-9de3-912e2ccb031d" />